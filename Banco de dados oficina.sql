CREATE DATABASE OFICINA;
USE OFICINA;

CREATE TABLE MECANICOS (
    ID_MECANICO INT AUTO_INCREMENT PRIMARY KEY,
    CPF CHAR(11) unique NOT NULL,
    NOME VARCHAR(100) NOT NULL,
    ESPECIALIZACAO ENUM('MECANICA','SUSPENSAO','VIDRO','ELETRICA','HIDRAULICA','OUTRA') DEFAULT 'MECANICA',
    TURNO_TRABALHO ENUM('M','T','M/T') NOT NULL DEFAULT 'M/T',
    VALOR_HORA FLOAT NOT NULL
);

ALTER TABLE MECANICOS AUTO_INCREMENT = 1;

CREATE TABLE PECAS (
    ID_PECA INT AUTO_INCREMENT PRIMARY KEY,
    NOME_PECA VARCHAR(100) NOT NULL,
    CODIGO_PECA VARCHAR(45) NOT NULL,
    QUANTIDADE_ESTOQUE INT,
    PRECO FLOAT,
    CONSTRAINT CODIGO_PECA_UNICO UNIQUE (CODIGO_PECA)
);

ALTER TABLE PECAS AUTO_INCREMENT = 1;

CREATE TABLE CLIENTES (
    ID_CLIENTE INT AUTO_INCREMENT PRIMARY KEY,
    NOME VARCHAR(100) NOT NULL,
    ENDERECO VARCHAR(200) NOT NULL,
    TELEFONE VARCHAR(20) NOT NULL,
    EMAIL VARCHAR(45),
    DATA_NASCIMENTO DATE
);

ALTER TABLE CLIENTES AUTO_INCREMENT = 1;

CREATE TABLE VEICULOS (
    ID_VEICULO INT AUTO_INCREMENT PRIMARY KEY,
    ID_CLIENTE INT NOT NULL,
    MARCA VARCHAR(45) NOT NULL,
    MODELO VARCHAR(45) NOT NULL,
    COR VARCHAR(45),
    ANO_FABRICACAO INT(4),
    PLACA VARCHAR(15) unique NOT NULL,
    CONSTRAINT FK_VEICULOS_CLIENTES FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE)
);

ALTER TABLE VEICULOS AUTO_INCREMENT = 1;

CREATE TABLE ORDENS_SERVICO (
    ID_ORDEM INT AUTO_INCREMENT PRIMARY KEY,
    ID_VEICULO INT,
    DATA_ABERTURA DATE NOT NULL,
    DATA_CONCLUSAO_ESTIMADA DATE,
    DATA_FINALIZACAO DATE,
    DESC_PROBLEMA VARCHAR(255),
	VALOR_ESTIMADO FLOAT,
    STATUS ENUM('EM AVALIACAO', 'EM MANUTENCAO', 'FINALIZADO') NOT NULL DEFAULT 'EM MANUTENCAO',
    CONSTRAINT FK_ORD_SERVICO_VEICULOS FOREIGN KEY (ID_VEICULO) REFERENCES VEICULOS(ID_VEICULO),
    CONSTRAINT CHECK_DATA_ABERTURA_DATA_FINALIZACAO CHECK (DATA_ABERTURA <= DATA_FINALIZACAO)
);

ALTER TABLE ORDENS_SERVICO AUTO_INCREMENT = 1;

CREATE TABLE LISTA_SERVICOS (
	ID_SERVICO INT AUTO_INCREMENT PRIMARY KEY,
	NOME_SERVICO VARCHAR(100) NOT NULL,
	PRECO FLOAT NOT NULL,
	TEMPO_ESTIMADO_HS FLOAT NOT NULL
);

ALTER TABLE LISTA_SERVICOS AUTO_INCREMENT = 1;

CREATE TABLE EXECUCAO (
	ID_EXECUCAO INT AUTO_INCREMENT PRIMARY KEY,
    ID_ORDEM INT,
    DESC_SERVICO VARCHAR(255) NOT NULL,
    PRECO FLOAT, -- PODE SER ATRIBUIDO UM VALOR TOTAL, OU CALCULADO POR MEIO DOS PRECOS DE PECAS E SERVICOS LISTADOS
    CONSTRAINT FK_EXECUCAO_ORD_SERVICO FOREIGN KEY (ID_ORDEM) REFERENCES ORDENS_SERVICO(ID_ORDEM)
);

ALTER TABLE EXECUCAO AUTO_INCREMENT = 1;

CREATE TABLE MECANICOS_EXECUCAO (
	ID_MECANICO INT,
    ID_EXECUCAO INT,
    CONSTRAINT FK_MECANICO_EXECUCAO_1 FOREIGN KEY (ID_MECANICO) REFERENCES MECANICOS(ID_MECANICO),
    CONSTRAINT FK_MECANICO_EXECUCAO_2 FOREIGN KEY (ID_EXECUCAO) REFERENCES EXECUCAO(ID_EXECUCAO)
);

CREATE TABLE PECAS_EXECUCAO (
	ID_PECA INT,
    ID_EXECUCAO INT,
    QUANTIDADE INT,
    CONSTRAINT FK_PECAS_EXECUCAO_1 FOREIGN KEY (ID_PECA) REFERENCES PECAS(ID_PECA),
    CONSTRAINT FK_PECAS_EXECUCAO_2 FOREIGN KEY (ID_EXECUCAO) REFERENCES EXECUCAO(ID_EXECUCAO)
);

CREATE TABLE SERVICOS_EXECUCAO (
	ID_SERVICO INT,
	ID_EXECUCAO INT,
	CONSTRAINT FK_SERVICO_EXECUCAO_1 FOREIGN KEY (ID_SERVICO) REFERENCES LISTA_SERVICOS(ID_SERVICO),
	CONSTRAINT FK_SERVICO_EXECUCAO_2 FOREIGN KEY (ID_EXECUCAO) REFERENCES EXECUCAO(ID_EXECUCAO)
);

-- POPULANDO BANCO DE DADOS

-- Populando a tabela MECANICOS
INSERT INTO MECANICOS (CPF, NOME, ESPECIALIZACAO, TURNO_TRABALHO, VALOR_HORA)
VALUES
    ('11111111111', 'Mecânico 1', 'MECANICA', 'M', 50.0),
    ('22222222222', 'Mecânico 2', 'SUSPENSAO', 'T', 55.0),
    ('33333333333', 'Mecânico 3', 'VIDRO', 'M/T', 45.0),
    ('44444444444', 'Mecânico 4', 'ELETRICA', 'M', 60.0),
    ('55555555555', 'Mecânico 5', 'HIDRAULICA', 'T', 52.0);

-- Populando a tabela PECAS
INSERT INTO PECAS (NOME_PECA, CODIGO_PECA, QUANTIDADE_ESTOQUE, PRECO)
VALUES
    ('Peça 1', 'P001', 100, 10.0),
    ('Peça 2', 'P002', 50, 15.0),
    ('Peça 3', 'P003', 75, 8.0),
    ('Peça 4', 'P004', 30, 20.0),
    ('Peça 5', 'P005', 60, 12.0);

-- Populando a tabela CLIENTES
INSERT INTO CLIENTES (NOME, ENDERECO, TELEFONE, EMAIL, DATA_NASCIMENTO)
VALUES
    ('Cliente 1', 'Endereço 1', '111-1111', 'cliente1@email.com', '1990-01-01'),
    ('Cliente 2', 'Endereço 2', '222-2222', 'cliente2@email.com', '1985-03-15'),
    ('Cliente 3', 'Endereço 3', '333-3333', NULL, '1988-07-20'),
    ('Cliente 4', 'Endereço 4', '444-4444', 'cliente4@email.com', '1995-12-10'),
    ('Cliente 5', 'Endereço 5', '555-5555', NULL, '1992-09-05');

-- Populando a tabela VEICULOS
INSERT INTO VEICULOS (ID_CLIENTE, MARCA, MODELO, COR, ANO_FABRICACAO, PLACA)
VALUES
    (1, 'Marca 1', 'Modelo 1', 'Vermelho', 2020, 'ABC123'),
    (2, 'Marca 2', 'Modelo 2', 'Azul', 2019, 'XYZ789'),
    (3, 'Marca 3', 'Modelo 3', 'Preto', 2022, 'DEF456'),
    (4, 'Marca 4', 'Modelo 4', 'Branco', 2018, 'GHI789'),
    (5, 'Marca 5', 'Modelo 5', 'Prata', 2021, 'JKL012');

-- Populando a tabela ORDENS_SERVICO
INSERT INTO ORDENS_SERVICO (ID_VEICULO, DATA_ABERTURA, DESC_PROBLEMA, VALOR_ESTIMADO, STATUS)
VALUES
    (1, '2023-08-01', 'Problema 1', 100.0, 'EM AVALIACAO'),
    (2, '2023-08-02', 'Problema 2', 80.0, 'EM MANUTENCAO'),
    (3, '2023-08-03', 'Problema 3', 120.0, 'EM AVALIACAO'),
    (4, '2023-08-04', 'Problema 4', 90.0, 'FINALIZADO'),
    (5, '2023-08-05', 'Problema 5', 110.0, 'EM MANUTENCAO');

-- Populando a tabela LISTA_SERVICOS
INSERT INTO LISTA_SERVICOS (NOME_SERVICO, PRECO, TEMPO_ESTIMADO_HS)
VALUES
    ('Serviço 1', 60.0, 2.5),
    ('Serviço 2', 45.0, 1.8),
    ('Serviço 3', 70.0, 3.0),
    ('Serviço 4', 55.0, 2.2),
    ('Serviço 5', 65.0, 2.7);

-- Populando a tabela EXECUCAO
INSERT INTO EXECUCAO (ID_ORDEM, DESC_SERVICO, PRECO)
VALUES
    (1, 'Execução Serviço 1', 60.0),
    (2, 'Execução Serviço 2', 45.0),
    (3, 'Execução Serviço 3', 70.0),
    (4, 'Execução Serviço 4', 55.0),
    (5, 'Execução Serviço 5', 65.0);

-- Populando a tabela MECANICOS_EXECUCAO
INSERT INTO MECANICOS_EXECUCAO (ID_MECANICO, ID_EXECUCAO)
VALUES
    (1, 1),
    (2, 2),
    (3, 3),
    (4, 4),
    (5, 5);

-- Populando a tabela PECAS_EXECUCAO
INSERT INTO PECAS_EXECUCAO (ID_PECA, ID_EXECUCAO, QUANTIDADE)
VALUES
    (1, 1, 2),
    (2, 2, 1),
    (3, 3, 3),
    (4, 4, 2),
    (5, 5, 4);

-- Populando a tabela SERVICOS_EXECUCAO
INSERT INTO SERVICOS_EXECUCAO (ID_SERVICO, ID_EXECUCAO)
VALUES
    (1, 1),
    (2, 2),
    (3, 3),
    (4, 4),
    (5, 5);
    
-- Perguntas 
-- Qual valor arrecado em todos os serviços executados?

SELECT SUM(PRECO) AS ValorArrecadado
FROM EXECUCAO;


-- O serviço de qual cliente foi mais caro?

SELECT
    C.NOME AS NomeCliente,
    E.DESC_SERVICO AS DescricaoServico,
    E.PRECO AS PrecoServico
FROM
    EXECUCAO E
INNER JOIN ORDENS_SERVICO OS ON E.ID_ORDEM = OS.ID_ORDEM
INNER JOIN VEICULOS V ON OS.ID_VEICULO = V.ID_VEICULO
INNER JOIN CLIENTES C ON V.ID_CLIENTE = C.ID_CLIENTE
ORDER BY E.PRECO DESC
LIMIT 1;

-- Qual o mecânico que fez o menor faturamento em serviços?

SELECT
    M.NOME AS NomeMecanico,
    SUM(E.PRECO) AS FaturamentoTotal
FROM
    MECANICOS M
LEFT JOIN MECANICOS_EXECUCAO ME ON M.ID_MECANICO = ME.ID_MECANICO
LEFT JOIN EXECUCAO E ON ME.ID_EXECUCAO = E.ID_EXECUCAO
GROUP BY M.NOME
ORDER BY FaturamentoTotal ASC
LIMIT 1;



